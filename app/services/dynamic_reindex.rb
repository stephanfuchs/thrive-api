class DynamicReindex
  attr_reader :account_id, :event_details, :entity, :entity_id

  # Examples
  #   1. { "Type" => "Notification", "MessageId" => "55662fef-3e13-5921-9807-711ff08c0be8", "TopicArn" => "arn:aws:sns:us-west-2:657325794363:thrivedrivethrivedevmessagebusthrivedrivethrivedevmessagebusMessageBusFC8A9E38-EventBusTopicD165DC44-AeDQTLc8dWjz", "Message" => "{\"event\":\"person.updated\",\"source\":\"drive_web_app_api\",\"eventTime\":1719061585,\"body\":{\"entity\":\"person\",\"entityId\":6957,\"accountId\":1,\"userId\":197,\"changeId\":\"qf3AhZCdmkT0DU3aIpZls\",\"changeSource\":\"WebUI\",\"changeSet\":{\"personId\":6957,\"firstName\":\"Smiths\",\"lastName\":\"\"}}}", "Timestamp" => "2024-06-22T13:06:39.123Z", "SignatureVersion" => "1", "Signature" => "oVkDGKBZ29ZDfCA21L3xgUccnToMrY3/zGSNHn3hA/ttKHyVx0wmpv/iZyYmL2GhBxtbn+fODgXt9PsgKK0o9yi+75zgH/aWs/tcisdnJDtMs9jnS6VJv0OceD9//6uCk5k4o/b9o/MEolBnnTOIcBj3rgSHEDdKDFwsOmzixuIyeYlzr06gz5wq1Xd4yvW2iUU/gJ/dWnmS2CI7gihqONjcBaFZAxaJE7OUwaI0/BcxiiC6oMgMhS+Q7fGzd0tuRUHLNHESeFkG34vi5ZyCSQ1riDkJSJM4dDYDHqxhLunSQZSyllus041RvEJzA95pibIflcOp8/WzvPefeuMbdQ==", "SigningCertURL" => "https://sns.us-west-2.amazonaws.com/SimpleNotificationService-60eadc530605d63b8e62a523676ef735.pem", "UnsubscribeURL" => "https://sns.us-west-2.amazonaws.com/?Action=Unsubscribe&SubscriptionArn=arn:aws:sns:us-west-2:657325794363:thrivedrivethrivedevmessagebusthrivedrivethrivedevmessagebusMessageBusFC8A9E38-EventBusTopicD165DC44-AeDQTLc8dWjz:f80642fb-40df-4da5-af33-3854bee5cf18", "MessageAttributes" => { "subject" => { "Type" => "String", "Value" => "person.updated" }, "source" => { "Type" => "String", "Value" => "drive_web_app_api" } } }.with_indifferent_access
  #   2. { "Type": "Notification", "MessageId": "78a0bfcc-d435-50f7-95a1-e13c01640863", "TopicArn": "arn:aws:sns:us-west-2:657325794363:thrivedrivethrivedevmessagebusthrivedrivethrivedevmessagebusMessageBusFC8A9E38-EventBusTopicD165DC44-AeDQTLc8dWjz", "Message": "{\"event\":\"company.updated\",\"source\":\"drive_web_app_api\",\"eventTime\":1719063313,\"body\":{\"entity\":\"company\",\"entityId\":831,\"accountId\":1,\"userId\":197,\"changeId\":\"pxaaVthdFNRui2vrEevxo\",\"changeSource\":\"WebUI\",\"changeSet\":{\"companyId\":831,\"name\":\"Agilityxxxx\"}}}", "Timestamp": "2024-06-22T13:35:13.965Z", "SignatureVersion": "1", "Signature": "MViL5HUnd1q443AzGyI1kVBuCVUisX+u9mKAcHShEWfwinVss7ik/3ttBBAhpqEfdfoXw9Hx1CC87mOJM4j+WKYzeLXojBsP4tUVS6a6KtK1MjUbuxr6fbigxuz5o4Ts87VEswF33xstK1eVIct4pcbZrO8mJ9Q1EkpZKJxbfcJXUUwgwN7omN5SQ0H59QHiUcq0448YB9pkM20/L6XiK7cg68CfrlKfvtv3RM4j+Yd1Ip2RyOcHUU1+qC0A1ISrKMU8zcQQwrZ1bV8MlYPni9QXDJS419Qpknj0bl4C4bTf058Bn4AAVMi9nzHGu7SwMeNio/loyCLx5y8PKLcm2g==", "SigningCertURL": "https://sns.us-west-2.amazonaws.com/SimpleNotificationService-60eadc530605d63b8e62a523676ef735.pem", "UnsubscribeURL": "https://sns.us-west-2.amazonaws.com/?Action=Unsubscribe&SubscriptionArn=arn:aws:sns:us-west-2:657325794363:thrivedrivethrivedevmessagebusthrivedrivethrivedevmessagebusMessageBusFC8A9E38-EventBusTopicD165DC44-AeDQTLc8dWjz:f80642fb-40df-4da5-af33-3854bee5cf18", "MessageAttributes": { "subject": {"Type":"String","Value":"company.updated"}, "source": {"Type":"String","Value":"drive_web_app_api"} } }.with_indifferent_access
  #   3. { "Type": "Notification", "MessageId": "59b5ea29-310c-591f-91b8-b4d9e954e636", "TopicArn": "arn:aws:sns:us-west-2:657325794363:thrivedrivethrivedevmessagebusthrivedrivethrivedevmessagebusMessageBusFC8A9E38-EventBusTopicD165DC44-AeDQTLc8dWjz", "Message": "{\"event\":\"prospect.updated\",\"source\":\"drive_web_app_api\",\"eventTime\":1719064088,\"body\":{\"entity\":\"prospect\",\"entityId\":4405,\"field\":\"prospect\",\"accountId\":1,\"userId\":197,\"changeId\":\"IxdBemXiDsJzZ_BiL1Flw\",\"changeSource\":\"WebUI\",\"changeSet\":{\"prospectId\":4405,\"title\":\"123LOL-Fexson44xxxxx\"}}}", "Timestamp": "2024-06-22T13:48:08.097Z", "SignatureVersion": "1", "Signature": "N+ItojLcKqigbsJzHXtfmjkBWQs5dH3GTdCWDA/WdSNqa+chWfWM/bQ4a2gN8s5+ZxLdgPr52hEVAIF3xkoGSwH1zuCgOCEXpi4wfvgrBWM7Ms6Gd0hqunJN8ciSigxPn037lkmbLC7dIxoKJxCULAj8pRMK9GVfSiftQ5luuc1CWjOkJkrvSRpBptSTbmufBkun+vznUp2Z8Ynggup02wv/yS4aays4qEN7Crr3xENscD7GtA5jcQvWgDCVZ6oc8Ds+ec0s2iusjwP1et803+xPk1rLZo0k+bhXFmnLqXv5xbHTMdc/0GJlaKD2qgssBiXqTqRHpo8548vOBJifMA==", "SigningCertURL": "https://sns.us-west-2.amazonaws.com/SimpleNotificationService-60eadc530605d63b8e62a523676ef735.pem", "UnsubscribeURL": "https://sns.us-west-2.amazonaws.com/?Action=Unsubscribe&SubscriptionArn=arn:aws:sns:us-west-2:657325794363:thrivedrivethrivedevmessagebusthrivedrivethrivedevmessagebusMessageBusFC8A9E38-EventBusTopicD165DC44-AeDQTLc8dWjz:f80642fb-40df-4da5-af33-3854bee5cf18", "MessageAttributes": { "subject": {"Type":"String","Value":"prospect.updated"}, "source": {"Type":"String","Value":"drive_web_app_api"} } }.with_indifferent_access

  def initialize(raw_message_body)
    @event_details = JSON.parse(raw_message_body['Message'] || '{}')['body'] || {}
    @account_id = @event_details['accountId']
    @entity_conversion = {
      person: Person,
      company: Company,
      prospect: Prospect,
    }.with_indifferent_access
    @entity = @entity_conversion[event_details['entity']]
    @entity_id = event_details['entityId']
  end

  def call
    # INFO: (Stephan) very important safeguard
    return unless account_id && entity
    entity.find_by(id: entity_id)&.reindex
  end
end
